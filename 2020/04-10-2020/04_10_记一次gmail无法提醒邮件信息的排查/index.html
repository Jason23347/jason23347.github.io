<!DOCTYPE html><html lang="en"><head><meta charset="utf-8"><meta http-equiv="X-UA-Compatible" content="IE=edge"><meta name="google-site-verification" content="xBT4GhYoi5qRD5tr338pgPM5OWHHIDR6mNg1a3euekI"><meta name="viewport" content="width=device-width,initial-scale=1"><meta name="description" content="Write an awesome description for your new site here. You can edit this
line in _config.yml. It will appear in your document head meta (for
Google search results) and in your feed.xml site description.
"><meta name="keyword" content=""><link rel="shortcut icon" href="/img/favicon.ico"><title>记一次GMAIL无法提醒邮件信息的排查 - undefined</title><link rel="stylesheet" href="/css/aircloud.css"><link rel="stylesheet" href="/css/gitment.css"><link href="//at.alicdn.com/t/font_620856_pl6z7sid89qkt9.css" rel="stylesheet"><script></script><style>body hl:after{content:' ';display:inline;font-family:Arial;font-size:.89em}html .tag-list-item hl,html code hl,html kbd hl,html pre hl,html ruby hl,html samp hl{display:none}html ol>hl,html ul>hl{display:none}</style><meta name="generator" content="Hexo 5.2.0"><link rel="alternate" href="/atom.xml" title="Jason's Simple Blog" type="application/atom+xml"></head><body><div class="site-nav-toggle" id="site-nav-toggle"><button><span class="btn-bar"></span> <span class="btn-bar"></span> <span class="btn-bar"></span></button></div><div class="index-about"><i></i></div><div class="index-container"><div class="index-left"><div class="nav" id="nav"><div class="avatar-name"><div class="avatar"><img src="///gravatar.com/avatar/fdaf3db072f81d12d1a1d8edb8b269ab?s=100"></div><div class="name"><i>Jason23347</i></div></div><div class="contents" id="nav-content"><ul><li><a href="/"><i class="iconfont icon-shouye1"></i> <span><hl></hl>主页</span></a></li><li><a href="/tags"><i class="iconfont icon-biaoqian1"></i> <span>标签</span></a></li><li><a href="/archive"><i class="iconfont icon-guidang2"></i> <span>存档</span></a></li><li><a href="/about/"><i class="iconfont icon-guanyu2"></i> <span>关于</span></a></li><li><a id="search"><i class="iconfont icon-sousuo1"></i> <span>搜索</span></a></li></ul></div><div id="toc" class="toc-article"><ol class="toc"><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%82%AE%E7%AE%B1%E6%9C%8D%E5%8A%A1%E5%99%A8%E4%B8%8E%E5%AE%A2%E6%88%B7%E7%AB%AF%E9%A6%96%E5%85%88%E6%88%91%E6%80%9D%E8%80%83%E4%BA%86%E4%BB%A5%E4%B8%8B%E6%88%91%E6%9C%80%E8%BF%91%E5%85%B3%E4%BA%8E%E9%82%AE%E4%BB%B6%E5%81%9A%E4%BA%86%E5%93%AA%E4%BA%9B%E8%AE%BE%E7%BD%AE%E9%82%AE%E4%BB%B6%E6%9C%8D%E5%8A%A1%E5%99%A8%E6%98%AF%E6%88%91%E8%87%AA%E5%B7%B1%E9%85%8D%E7%9A%84%E5%AE%A2%E6%88%B7%E7%AB%AF%E5%88%99%E6%9C%89%E4%B8%89%E4%B8%AA"><span class="toc-text">邮箱服务器与客户端首先我思考了以下我最近关于邮件做了哪些设置，邮件服务器是我自己配的，客户端则有三个：<hl></hl></span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#cron%E4%BB%BB%E5%8A%A1%E4%B8%8Efetchmail"><span class="toc-text">cron<hl></hl>任务与<hl></hl>fetchmail</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E7%9C%9F%E7%9B%B8%E5%A4%A7%E7%99%BD%E5%8E%9F%E6%9D%A5%E9%97%AE%E9%A2%98%E5%A4%84%E5%9C%A8fetchmail%E8%BA%AB%E4%B8%8A"><span class="toc-text"><hl></hl>真相大白原来问题处在<hl></hl>fetchmail<hl></hl>身上！</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E9%97%AE%E9%A2%98%E8%A7%A3%E5%86%B3%E5%88%9A%E6%89%8D%E7%9A%84%E8%AE%A8%E8%AE%BA%E6%8E%A8%E6%B5%8B%E5%87%BA%E4%BA%86%E9%97%AE%E9%A2%98%E7%9A%84%E8%B5%B7%E5%9B%A0%E4%BD%86%E6%98%AF%E6%B2%A1%E6%9C%89%E6%B6%89%E5%8F%8A%E5%88%B0%E9%97%AE%E9%A2%98%E7%9A%84%E6%9C%AC%E8%B4%A8%E9%82%A3%E5%B0%B1%E6%98%AF%E4%B8%BA%E4%BB%80%E4%B9%88fetchmail%E6%8B%89%E5%8F%96%E9%82%AE%E4%BB%B6%E4%B9%8B%E5%90%8E%E9%82%AE%E4%BB%B6%E8%A2%AB%E6%A0%87%E8%AE%B0%E6%88%90%E5%B7%B2%E8%AF%BB%E9%80%9A%E8%BF%87%E6%9F%A5%E9%98%85%E8%B5%84%E6%96%99%E5%BE%97%E7%9F%A5"><span class="toc-text"><hl></hl>问题解决刚才的讨论推测出了问题的起因，但是没有涉及到问题的本质，那就是，为什么<hl></hl>fetchmail<hl></hl>拉取邮件之后，邮件被标记成已读？通过查阅资料得知</span></a></li><li class="toc-item toc-level-4"><a class="toc-link" href="#%E8%BF%9B%E9%98%B6crontab"><span class="toc-text"><hl></hl>进阶<hl></hl>crontab</span></a></li></ol></div></div><div class="search-field" id="search-field"><div class="search-container"><div class="search-input"><span id="esc-search"><i class="icon-fanhui iconfont"></i></span> <input id="search-input"> <span id="begin-search">搜索</span></div><div class="search-result-container" id="search-result-container"></div></div></div><div class="index-about-mobile"><i><hl></hl></i></div></div><div class="index-middle"><div class="post-container"><div class="post-title">记一次<hl></hl>GMAIL<hl></hl>无法提醒邮件信息的排查</div><div class="post-meta"><span class="attr">发布于：<span>2020-04-10 11:59:23</span></span> <span class="attr"><hl></hl>标签：/ <a class="tag" href="/tags/#shell" title="shell">shell</a> <span>/</span> <a class="tag" href="/tags/#fetchmail" title="fetchmail">fetchmail</a> <span>/</span> <a class="tag" href="/tags/#cron" title="cron">cron</a> <span>/</span> </span><span class="attr"><hl></hl>访问：<span id="busuanzi_value_page_pv"></span></span></div><div class="post-content"><blockquote><p><hl></hl>最近发现手机上<hl></hl>GMAIL<hl></hl>总是不提醒新的邮件，并且消息都变成了已读。这使得我总是收不到来自<hl></hl>github<hl></hl>和<hl></hl>gitlab<hl></hl>的消息通知。这个问题很早就出现过了，最近出现得十分频繁，今天我把它解决了。</p></blockquote><h4 id="邮箱服务器与客户端首先我思考了以下我最近关于邮件做了哪些设置邮件服务器是我自己配的客户端则有三个">邮箱服务器与客户端首先我思考了以下我最近关于邮件做了哪些设置，邮件服务器是我自己配的，客户端则有三个：</h4><ul><hl></hl><li>Ubuntu<hl></hl>上的<hl></hl><code>mutt</code>+<code>fetchmail</code>+<code>maildrop</code></li><hl></hl><li>Andriod<hl></hl>上的<hl></hl><code>GMAIL</code></li><li>Microsoft Flow</li></ul><p><hl></hl>其中最后一个是手机上一个提供简易自动化任务的软件，一个月前我设置过检测<hl></hl>GMAIL<hl></hl>邮件并弹出提示，不过因为不好用就把任务删除了。再次检查确定没有任务读取<hl></hl>GMAIL，虽然它看起来最可疑，但却是最先被排除的。其次思考<hl></hl>GMAIL，GMAIL<hl></hl>可能会收到消息但不提醒，但是不会收到消息直接变成已读，所以先保留。最后就是<hl></hl>fetchmail<hl></hl>的检查了。</p><hl></hl><h4 id="cron任务与fetchmail">cron<hl></hl>任务与<hl></hl>fetchmail</h4><p><hl></hl>以<hl></hl>man page<hl></hl>的自我介绍来说，<code>fetchmail</code> is a mail-retrieval and forwarding utility.</p><p><hl></hl>我用它来拉取邮件列表，cron<hl></hl>任务如下所示</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">*/5 * * * * fetchmail</span><br></pre></td></tr></tbody></table></figure><p></p><p><hl></hl>然后我恍然大悟，原本的<hl></hl>cron<hl></hl>任务是每<hl></hl>15<hl></hl>分钟一次，现在被我改成了<hl></hl>5<hl></hl>分钟一次，自此我的<hl></hl>GMAIL<hl></hl>才无法正常获取邮件列表。</p><h4 id="真相大白原来问题处在fetchmail身上"><hl></hl>真相大白原来问题处在<hl></hl>fetchmail<hl></hl>身上！</h4><hl></hl><p>GMAIL<hl></hl>能够设置的最短拉取邮件列表的时间就是<hl></hl>15<hl></hl>分钟，以往两者的时间间隔相等，所以<hl></hl>GMAIL<hl></hl>有一定的的概率先拉取邮件，但是当<hl></hl>fetchmail<hl></hl>查询间隔变为<hl></hl>5<hl></hl>分钟之后，GMAIL<hl></hl>就没有一丝机会获取到新的邮件了。</p><h4 id="问题解决刚才的讨论推测出了问题的起因但是没有涉及到问题的本质那就是为什么fetchmail拉取邮件之后邮件被标记成已读通过查阅资料得知"><hl></hl>问题解决刚才的讨论推测出了问题的起因，但是没有涉及到问题的本质，那就是，为什么<hl></hl>fetchmail<hl></hl>拉取邮件之后，邮件被标记成已读？通过查阅资料得知</h4><ul><hl></hl><li>fetchmail<hl></hl>标记信息为已读的问题自古就已经存在</li><li>有的人没有办法，有的人自己写了插件</li></ul><p><hl></hl>我怎么办呢，我端详我的<hl></hl>fetchmail<hl></hl>配置文件，在里面找到一个关键字，<code>imap</code> file: ~/.fetchmailrc</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">defaults</span><br><span class="line">mda <span class="string">"/usr/bin/maildrop"</span></span><br><span class="line"></span><br><span class="line">poll imap.jason233.top</span><br><span class="line">proto imap</span><br><span class="line">port 143</span><br><span class="line">user jason@jason233.top</span><br><span class="line">password ******</span><br><span class="line">mimedecode</span><br><span class="line">keep</span><br></pre></td></tr></tbody></table></figure><p></p><p><hl></hl>众所周知，IMAP<hl></hl>和<hl></hl>POP3<hl></hl>都是邮件服务器常用的协议，对于两者的详细区别不再赘述。通俗来讲，POP3<hl></hl>是<hl></hl>“只读”<hl></hl>的，IMAP<hl></hl>是<hl></hl>“同步修改”<hl></hl>的。所以，把<hl></hl>IMAP<hl></hl>换成<hl></hl>POP3<hl></hl>就可以了。</p><p><hl></hl>只要过了这一波测试...<hl></hl>还不行。不过小场面，不要慌，继续查阅资料，添加一个<hl></hl>UIDL<hl></hl>参数就可以了。</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">defaults</span><br><span class="line">mda <span class="string">"/usr/bin/maildrop"</span></span><br><span class="line"></span><br><span class="line">poll pop3.jason233.top</span><br><span class="line">proto po3</span><br><span class="line">port 110</span><br><span class="line">uidl</span><br><span class="line">user jason@jason233.top</span><br><span class="line">password ******</span><br><span class="line">mimedecode</span><br><span class="line">keep</span><br></pre></td></tr></tbody></table></figure><h4 id="进阶crontab"><hl></hl>进阶<hl></hl>crontab</h4><p><hl></hl>通过<hl></hl>cron<hl></hl>任务发桌面提醒我有新邮件。</p><p>cron:</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line">*/5 * * * * /home/jason/.<span class="built_in">local</span>/bin/fetchmail-and-notify</span><br></pre></td></tr></tbody></table></figure><p></p><p>file: fetchmail-and-notify</p><figure class="highlight bash"><table><tbody><tr><td class="code"><pre><span class="line"><span class="meta">#!/bin/bash</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># env for notify-send</span></span><br><span class="line"><span class="built_in">export</span> DISPLAY=:0</span><br><span class="line"><span class="built_in">export</span> DBUS_SESSION_BUS_ADDRESS=<span class="string">"unix:path=/run/user/1000/bus"</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># config</span></span><br><span class="line">MAIL_INBOX=~/mail/personal/jason/INBOX</span><br><span class="line">LOG_FILE=~/mail/<span class="built_in">log</span>/notify.log</span><br><span class="line">TIMESTAMP_FILE=~/mail/last_check</span><br><span class="line"></span><br><span class="line"><span class="comment"># open log stream (append)</span></span><br><span class="line"><span class="built_in">exec</span> 3&gt;&gt;<span class="variable">$LOG_FILE</span></span><br><span class="line"><span class="function"><span class="title">write_log</span></span>() {</span><br><span class="line">    <span class="built_in">echo</span> <span class="string">"[<span class="subst">$(date +'%Y-%m-%d %H:%M:%S')</span>] <span class="variable">$1</span>"</span> &gt;&amp;3</span><br><span class="line">}</span><br><span class="line"></span><br><span class="line"><span class="comment"># fetch mail</span></span><br><span class="line">fetchmail</span><br><span class="line"></span><br><span class="line">last=$(cat <span class="variable">$TIMESTAMP_FILE</span>)</span><br><span class="line"><span class="built_in">echo</span> $(date +%s) &gt;<span class="variable">$TIMESTAMP_FILE</span></span><br><span class="line">write_log <span class="string">"Updated timestamp cache."</span></span><br><span class="line"></span><br><span class="line">modified=$(<span class="built_in">stat</span> -c <span class="string">'%Y'</span> <span class="string">"<span class="variable">$MAIL_INBOX</span>"</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># TODO use inotify instead</span></span><br><span class="line"><span class="comment"># compare timestamp</span></span><br><span class="line"><span class="keyword">if</span> [ $((modified - last)) -gt 10 ]; <span class="keyword">then</span></span><br><span class="line">    <span class="comment"># show notification</span></span><br><span class="line">    notify-send <span class="string">"mail"</span> <span class="string">"You have new mail."</span> -i mutt</span><br><span class="line">    write_log <span class="string">"Sent a notify."</span></span><br><span class="line"><span class="keyword">fi</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># close log stream</span></span><br><span class="line"><span class="built_in">exec</span> 3&gt;&amp;-</span><br></pre></td></tr></tbody></table></figure><p></p><p><strong>P.S.<hl></hl></strong>关于邮箱服务器的配置鉴于我的阿里云服务器<hl></hl>25<hl></hl>端口（SMTP）封禁，正常的邮箱设置也就是通过邮件服务器发送邮件给其他人是行不通的。所以我就在本机上又搭了一个邮件服务器，没错我又装了一个<hl></hl>Postfix。</p><br><div id="comment-container"></div><div id="disqus_thread"></div><div id="lv-container"></div></div></div></div></div><footer class="footer"><ul class="list-inline text-center"><li><a target="_blank" href="https://github.com/Jason23347"><span class="fa-stack fa-lg"><i class="iconfont icon-github"></i></span></a></li></ul><p><span id="busuanzi_container_site_pv"><span id="busuanzi_value_site_pv"></span>PV </span><span id="busuanzi_container_site_uv"><span id="busuanzi_value_site_uv"></span>UV </span>Created By <a target="_blank" rel="noopener" href="https://hexo.io/">Hexo</a> Theme <a target="_blank" rel="noopener" href="https://github.com/aircloud/hexo-theme-aircloud">AirCloud</a></p></footer><script>window.hexo_search_path="search.json",window.hexo_root="/",window.isPost=!0</script><script src="https://cdn.bootcss.com/jquery/3.3.1/jquery.min.js"></script><script src="/js/index.js"></script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script></body></html>